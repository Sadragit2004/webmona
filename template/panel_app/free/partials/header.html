<header class="bg-white shadow-sm">
    <div class="container mx-auto px-4 py-3 flex flex-col md:flex-row md:justify-between md:items-center space-y-4 md:space-y-0">
        <div class="flex items-center space-x-2 space-x-reverse">
            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold">
                {{ request.user.name }}
            </div>
            <h1 class="text-xl font-bold" id="pageTitle">پنل کاربری</h1>
        </div>

        <div class="flex items-center justify-between w-full md:w-auto">
            <div class="flex items-center space-x-2 space-x-reverse flex-nowrap overflow-x-auto">
                <a href="{% url 'panel:user_menus' %}"
                   class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg text-sm transition-colors flex items-center space-x-2 space-x-reverse whitespace-nowrap">
                    <i class="fas fa-print"></i>
                    <span>چاپ کارت</span>
                </a>

                {% if user_restaurants %}
                <button onclick="openCreateRestaurantModal()"
                        class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm transition-colors whitespace-nowrap">
                    افتتاح رستوران جدید
                </button>
                {% endif %}

                <form method="post" action="{% url 'account:logout' %}">
                    {% csrf_token %}
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-sm transition-colors whitespace-nowrap">
                        خروج
                    </button>
                </form>
            </div>

            <button class="text-gray-600 md:hidden ml-4" id="mobileMenuButton">
                <i class="fas fa-bars text-xl"></i>
            </button>
        </div>
    </div>
</header>

<!-- مودال افتتاح رستوران -->
<!-- مودال افتتاح رستوران -->
<div id="createRestaurantModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 overflow-y-auto">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg mx-auto">
            <!-- هدر مودال -->
            <div class="flex justify-between items-center p-6 border-b border-gray-100">
                <div class="flex items-center space-x-2 space-x-reverse">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center text-white">
                        <i class="fas fa-utensils text-sm"></i>
                    </div>
                    <h3 class="text-lg font-bold text-gray-800">افتتاح رستوران جدید</h3>
                </div>
                <button onclick="closeCreateRestaurantModal()"
                        class="w-8 h-8 rounded-full bg-gray-100 hover:bg-gray-200 flex items-center justify-center text-gray-500 hover:text-gray-700 transition-colors">
                    <i class="fas fa-times text-sm"></i>
                </button>
            </div>

            <!-- Progress Steps -->
            <div class="px-6 py-4 border-b border-gray-100">
                <div class="flex items-center justify-between">
                    <div class="flex flex-col items-center">
                        <div id="step1Indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium transition-all bg-blue-500 text-white">
                            1
                        </div>
                        <span class="text-xs mt-1 text-blue-500 font-medium">اطلاعات پایه</span>
                    </div>
                    <div id="step1Line" class="h-1 flex-1 mx-2 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="step2Indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium transition-all bg-gray-200 text-gray-500">
                            2
                        </div>
                        <span class="text-xs mt-1 text-gray-500">نام انگلیسی</span>
                    </div>
                    <div id="step2Line" class="h-1 flex-1 mx-2 bg-gray-200"></div>
                    <div class="flex flex-col items-center">
                        <div id="step3Indicator" class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-medium transition-all bg-gray-200 text-gray-500">
                            3
                        </div>
                        <span class="text-xs mt-1 text-gray-500">نوع ساخت</span>
                    </div>
                </div>
            </div>

            <!-- محتوای مودال -->
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <!-- Step 1: اطلاعات پایه -->
                <div id="step1" class="step-content space-y-5">
                    <div class="text-center mb-2">
                        <div class="w-16 h-16 bg-gradient-to-r from-blue-100 to-blue-50 rounded-full flex items-center justify-center text-blue-500 mx-auto mb-3">
                            <i class="fas fa-info-circle text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">اطلاعات پایه رستوران</h4>
                        <p class="text-sm text-gray-600 mt-1">لطفاً اطلاعات اولیه رستوران خود را وارد کنید</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نام کامل</label>
                            <input type="text" id="fullNameInput"
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                   placeholder="نام و نام خانوادگی خود را وارد کنید"
                                   value="{{ request.user.name|default:'' }} {{ request.user.family|default:'' }}"
                                   autofocus>
                            <p class="text-xs text-gray-500 mt-1">نام و نام خانوادگی خود را با فاصله وارد کنید</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نام رستوران</label>
                            <input type="text" id="restaurantNameInput"
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                   placeholder="مثال: رستوران شاندیز">
                        </div>
                    </div>
                    <div class="flex justify-end mt-6">
                        <button onclick="proceedToStep2()"
                                class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-8 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg">
                            مرحله بعد
                            <i class="fas fa-arrow-left mr-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 2: نام انگلیسی -->
                <div id="step2" class="step-content hidden space-y-5">
                    <div class="text-center mb-2">
                        <div class="w-16 h-16 bg-gradient-to-r from-green-100 to-green-50 rounded-full flex items-center justify-center text-green-500 mx-auto mb-3">
                            <i class="fas fa-language text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">نام انگلیسی رستوران</h4>
                        <p class="text-sm text-gray-600 mt-1">نام انگلیسی منحصر به فرد برای رستوران خود انتخاب کنید</p>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">نام انگلیسی</label>
                            <input type="text" id="englishNameInput"
                                   class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all"
                                   placeholder="مثال: my-restaurant"
                                   autofocus
                                   oninput="checkEnglishName()">
                            <div id="englishNameFeedback" class="text-sm mt-2 flex items-center space-x-1 space-x-reverse"></div>
                        </div>
                        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-100">
                            <p class="text-sm text-gray-700 flex items-center">
                                <i class="fas fa-link text-blue-500 ml-2"></i>
                                آدرس منوی شما:
                                <span id="menuUrlPreview" class="font-mono text-blue-600 bg-blue-100 px-2 py-1 rounded mr-2">/menu/</span>
                            </p>
                        </div>
                    </div>
                    <div class="flex justify-between mt-6">
                        <button onclick="backToStep1()"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105">
                            <i class="fas fa-arrow-right ml-2"></i>
                            بازگشت
                        </button>
                        <button id="step2Button" onclick="proceedToStep3()"
                                class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-8 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                disabled>
                            تأیید و ادامه
                            <i class="fas fa-arrow-left mr-2"></i>
                        </button>
                    </div>
                </div>

                <!-- Step 3: انتخاب نوع ساخت منو -->
                <div id="step3" class="step-content hidden space-y-5">
                    <div class="text-center mb-2">
                        <div class="w-16 h-16 bg-gradient-to-r from-purple-100 to-purple-50 rounded-full flex items-center justify-center text-purple-500 mx-auto mb-3">
                            <i class="fas fa-utensils text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">نحوه ساخت منو را انتخاب کنید</h4>
                        <p class="text-sm text-gray-600 mt-1">روش مورد نظر خود برای ایجاد منوی رستوران را انتخاب نمایید</p>
                    </div>

                    <div class="space-y-4">
                        <button onclick="selectMenuCreation('self')"
                                class="w-full p-5 border-2 border-green-200 rounded-2xl text-right hover:border-green-500 hover:bg-green-50 transition-all duration-300 transform hover:scale-[1.02] group">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-green-600 group-hover:bg-green-200 transition-colors">
                                    <i class="fas fa-user-edit text-xl"></i>
                                </div>
                                <div class="flex-1 mr-4">
                                    <div class="font-bold text-gray-800 text-lg">خودم می‌سازم</div>
                                    <div class="text-sm text-gray-600 mt-1">منوی رستوران را خودم طراحی و تنظیم می‌کنم</div>
                                </div>
                                <div class="w-6 h-6 rounded-full border-2 border-green-500 flex items-center justify-center">
                                    <div class="w-3 h-3 rounded-full bg-green-500 hidden"></div>
                                </div>
                            </div>
                        </button>

                        <button onclick="selectMenuCreation('company')"
                                class="w-full p-5 border-2 border-blue-200 rounded-2xl text-right hover:border-blue-500 hover:bg-blue-50 transition-all duration-300 transform hover:scale-[1.02] group">
                            <div class="flex items-center justify-between">
                                <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600 group-hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-building text-xl"></i>
                                </div>
                                <div class="flex-1 mr-4">
                                    <div class="font-bold text-gray-800 text-lg">شرکت می‌سازد</div>
                                    <div class="text-sm text-gray-600 mt-1">تیم پشتیبانی منوی حرفه‌ای برای شما می‌سازد</div>
                                </div>
                                <div class="w-6 h-6 rounded-full border-2 border-blue-500 flex items-center justify-center">
                                    <div class="w-3 h-3 rounded-full bg-blue-500 hidden"></div>
                                </div>
                            </div>
                        </button>
                    </div>

                    <div class="bg-gradient-to-r from-yellow-50 to-orange-50 p-4 rounded-xl border border-yellow-200 mt-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-yellow-500 ml-2 mt-1"></i>
                            <div class="text-sm text-yellow-800 text-right">
                                <div class="font-bold">هزینه ساخت منو توسط شرکت: ۹۹,۰۰۰ تومان</div>
                                <div class="mt-1">در صورت انتخاب گزینه "شرکت می‌سازد" این هزینه دریافت خواهد شد</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 4: آپلود عکس منو و انتخاب سئو -->
                <div id="step4" class="step-content hidden space-y-5">
                    <div class="text-center mb-2">
                        <div class="w-16 h-16 bg-gradient-to-r from-indigo-100 to-indigo-50 rounded-full flex items-center justify-center text-indigo-500 mx-auto mb-3">
                            <i class="fas fa-images text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-lg text-gray-800">عکس‌های منو را آپلود کنید</h4>
                        <p class="text-sm text-gray-600 mt-1">عکس‌های منوی فعلی خود را برای ساخت منوی دیجیتال آپلود کنید</p>
                    </div>

                    <!-- کارت انتخاب سئو -->
                    <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-2 border-purple-200 rounded-2xl p-4 transition-all duration-300 hover:border-purple-400 cursor-pointer"
                         onclick="toggleSeoOption()">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3 space-x-reverse">
                                <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center text-white">
                                    <i class="fas fa-search-plus text-sm"></i>
                                </div>
                                <div class="text-right">
                                    <div class="font-bold text-gray-800 flex items-center">
                                        سئو و بهینه‌سازی منو
                                        <span class="bg-gradient-to-r from-purple-500 to-pink-500 text-white text-xs px-2 py-1 rounded-full mr-2">پیشنهاد ویژه</span>
                                    </div>
                                    <div class="text-sm text-gray-600 mt-1">منوی شما در نتایج جستجوی گوگل نمایش داده می‌شود</div>
                                </div>
                            </div>
                            <div class="relative">
                                <input type="checkbox" id="seoOption" class="hidden">
                                <div id="seoCheckbox" class="w-6 h-6 rounded border-2 border-gray-300 flex items-center justify-center transition-all duration-200">
                                    <i class="fas fa-check text-white text-xs transition-all duration-200 opacity-0"></i>
                                </div>
                            </div>
                        </div>

                        <!-- جزئیات هزینه سئو -->
                        <div id="seoPriceDetails" class="mt-3 p-3 bg-white rounded-xl border border-purple-100 hidden">
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-600">هزینه ساخت منو:</span>
                                <span class="font-bold">۹۹,۰۰۰ تومان</span>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2">
                                <span class="text-purple-600">هزینه سئو و بهینه‌سازی:</span>
                                <span class="font-bold text-purple-600">+۳۹,۰۰۰ تومان</span>
                            </div>
                            <div class="flex justify-between items-center text-sm mt-2 pt-2 border-t border-gray-200">
                                <span class="text-gray-800 font-bold">مبلغ قابل پرداخت:</span>
                                <span id="totalPrice" class="font-bold text-lg text-green-600">۹۹,۰۰۰ تومان</span>
                            </div>
                        </div>

                        <!-- توضیحات سئو -->
                        <div class="mt-3 text-xs text-purple-700 bg-purple-100 p-2 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb ml-1 mt-0.5"></i>
                                <span>با سئو، مشتریان بیشتری منوی شما را در گوگل پیدا می‌کنند و فروش افزایش می‌یابد</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-xl border border-blue-200 mb-4">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 ml-2 mt-1"></i>
                            <div class="text-sm text-blue-800 text-right">
                                <div class="font-bold">می‌توانید حداکثر ۱۰ عکس آپلود کنید</div>
                                <div class="mt-1">عکس‌های منوی فعلی خود را آپلود کنید تا تیم پشتیبانی برای شما منوی دیجیتال ایجاد کند</div>
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <!-- منطقه کشیدن و رها کردن -->
                        <div id="dropZone"
                             class="border-2 border-dashed border-gray-300 rounded-2xl p-6 text-center hover:border-blue-500 transition-all duration-300 cursor-pointer bg-gray-50 hover:bg-blue-50">
                            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
                            <p class="text-gray-600 font-medium">برای انتخاب عکس‌ها اینجا کلیک کنید</p>
                            <p class="text-sm text-gray-500 mt-2">یا عکس‌ها را اینجا بکشید و رها کنید (حداکثر ۱۰ عکس)</p>
                            <input type="file" id="menuImagesInput" multiple accept="image/*" class="hidden">
                        </div>

                        <!-- شمارنده عکس‌ها -->
                        <div id="imageCounter" class="flex justify-between items-center bg-gray-100 p-3 rounded-xl hidden">
                            <div class="text-sm text-gray-700">
                                <span id="currentCount" class="font-bold">0</span> از <span id="maxCount" class="font-bold">10</span> عکس انتخاب شده
                            </div>
                            <div id="progressBar" class="w-24 h-2 bg-gray-300 rounded-full overflow-hidden">
                                <div id="progressFill" class="h-full bg-green-500 transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- پیشنمایش عکس‌ها -->
                        <div id="imagePreview" class="grid grid-cols-3 gap-3 mt-4 hidden">
                            <!-- عکس‌ها اینجا نمایش داده می‌شوند -->
                        </div>
                    </div>

                    <div class="flex justify-between mt-8">
                        <button onclick="backToStep3()"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105">
                            <i class="fas fa-arrow-right ml-2"></i>
                            بازگشت
                        </button>
                        <div class="flex space-x-2 space-x-reverse">
                            <button id="saveImagesButton" onclick="saveImages()"
                                    class="bg-gradient-to-r from-green-500 to-emerald-500 hover:from-green-600 hover:to-emerald-600 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    disabled>
                                <i class="fas fa-save ml-2"></i>
                                ذخیره عکس‌ها
                            </button>
                            <button id="uploadButton" onclick="proceedToPayment()"
                                    class="bg-gradient-to-r from-blue-500 to-purple-500 hover:from-blue-600 hover:to-purple-600 text-white px-6 py-3 rounded-xl transition-all transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                                    disabled>
                                ادامه به پرداخت
                                <i class="fas fa-arrow-left mr-2"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Step 5: در حال پردازش -->
                <div id="step5" class="step-content hidden">
                    <div class="text-center py-8">
                        <div class="w-20 h-20 bg-gradient-to-r from-blue-100 to-purple-100 rounded-full flex items-center justify-center text-blue-500 mx-auto mb-4">
                            <i class="fas fa-spinner fa-spin text-3xl"></i>
                        </div>
                        <h4 class="font-bold text-xl text-gray-800 mb-3" id="processingTitle">در حال ایجاد رستوران...</h4>
                        <p class="text-gray-600" id="processingMessage">لطفاً چند لحظه صبر کنید</p>

                        <div class="w-full bg-gray-200 rounded-full h-2 mt-6">
                            <div id="progressBarAnimated" class="h-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full transition-all duration-500"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// متغیرهای سراسری
let currentStep = 1;
let restaurantData = {
    step1: {},
    step2: {},
    menuCreationType: null,
    uploadedImages: [],
    imagesSaved: false,
    isSeoEnabled: true  // فعال بودن پیش‌فرض
};
const MAX_IMAGES = 10;

// قیمت‌ها - هماهنگ با مدل Django
const BASE_PRICE = 99000 * 10;  // 990,000 تومان
const SEO_EXTRA_PRICE = 39000 * 10;  // 390,000 تومان

let fullNameTimeout;
let autoFocusTimeout;
let checkTimeout;

// مدیریت مودال
function openCreateRestaurantModal() {
    document.getElementById('createRestaurantModal').classList.remove('hidden');
    showStep(1);
    resetForm();
    updateProgress();

    setTimeout(() => {
        const fullNameInput = document.getElementById('fullNameInput');
        if (fullNameInput) {
            fullNameInput.focus();
        }
    }, 300);
}

function closeCreateRestaurantModal() {
    document.getElementById('createRestaurantModal').classList.add('hidden');
    resetForm();
}

function showStep(step) {
    currentStep = step;
    document.querySelectorAll('.step-content').forEach(el => {
        el.classList.add('hidden');
    });

    const currentStepElement = document.getElementById(`step${step}`);
    if (currentStepElement) {
        currentStepElement.classList.remove('hidden');
    }

    if (step === 4) {
        setTimeout(() => {
            setupFileUpload();
            updateTotalPrice();
        }, 100);
    }

    updateProgress();

    setTimeout(() => {
        let focusElement = null;
        if (step === 1) {
            focusElement = document.getElementById('fullNameInput');
        } else if (step === 2) {
            focusElement = document.getElementById('englishNameInput');
        }

        if (focusElement) {
            focusElement.focus();
        }
    }, 400);
}

function updateProgress() {
    const steps = [1, 2, 3];
    steps.forEach(step => {
        const indicator = document.getElementById(`step${step}Indicator`);
        const line = document.getElementById(`step${step}Line`);

        if (step <= currentStep) {
            if (indicator) {
                indicator.classList.remove('bg-gray-200', 'text-gray-500');
                indicator.classList.add('bg-blue-500', 'text-white');
            }
            if (line && step < 3) {
                line.classList.remove('bg-gray-200');
                line.classList.add('bg-blue-500');
            }
        } else {
            if (indicator) {
                indicator.classList.remove('bg-blue-500', 'text-white');
                indicator.classList.add('bg-gray-200', 'text-gray-500');
            }
            if (line && step < 3) {
                line.classList.remove('bg-blue-500');
                line.classList.add('bg-gray-200');
            }
        }
    });
}

function resetForm() {
    showStep(1);

    const englishNameFeedback = document.getElementById('englishNameFeedback');
    const step2Button = document.getElementById('step2Button');
    const englishNameInput = document.getElementById('englishNameInput');
    const restaurantNameInput = document.getElementById('restaurantNameInput');
    const fullNameInput = document.getElementById('fullNameInput');
    const uploadButton = document.getElementById('uploadButton');
    const saveImagesButton = document.getElementById('saveImagesButton');

    if (englishNameFeedback) englishNameFeedback.innerHTML = '';
    if (step2Button) step2Button.disabled = true;
    if (englishNameInput) englishNameInput.value = '';
    if (restaurantNameInput) restaurantNameInput.value = '';
    if (fullNameInput) fullNameInput.value = '{{ request.user.name|default:"" }} {{ request.user.family|default:"" }}';
    if (uploadButton) uploadButton.disabled = true;
    if (saveImagesButton) saveImagesButton.disabled = true;

    // فعال بودن پیش‌فرض سئو
    restaurantData.isSeoEnabled = true;
    updateSeoCheckbox();
    updateTotalPrice();

    restaurantData = {
        step1: {},
        step2: {},
        menuCreationType: null,
        uploadedImages: [],
        imagesSaved: false,
        isSeoEnabled: true  // فعال بودن پیش‌فرض
    };

    const preview = document.getElementById('imagePreview');
    const imageCounter = document.getElementById('imageCounter');

    if (preview) {
        preview.innerHTML = '';
        preview.classList.add('hidden');
    }
    if (imageCounter) {
        imageCounter.classList.add('hidden');
    }

    const dropZone = document.getElementById('dropZone');
    if (dropZone) {
        dropZone.classList.remove('border-green-400', 'border-red-400', 'opacity-50', 'cursor-not-allowed');
        dropZone.classList.add('border-gray-300', 'cursor-pointer');
        dropZone.innerHTML = `
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-600 font-medium">برای انتخاب عکس‌ها اینجا کلیک کنید</p>
            <p class="text-sm text-gray-500 mt-2">یا عکس‌ها را اینجا بکشید و رها کنید (حداکثر ۱۰ عکس)</p>
            <input type="file" id="menuImagesInput" multiple accept="image/*" class="hidden">
        `;
    }

    document.querySelectorAll('.upload-message').forEach(msg => msg.remove());

    const menuImagesInput = document.getElementById('menuImagesInput');
    if (menuImagesInput) {
        menuImagesInput.value = '';
    }

    updateProgress();
}

// مدیریت گزینه سئو
function toggleSeoOption() {
    restaurantData.isSeoEnabled = !restaurantData.isSeoEnabled;
    updateSeoCheckbox();
    updateTotalPrice();

    console.log('سئو فعال شد:', restaurantData.isSeoEnabled);
    console.log('قیمت نهایی:', BASE_PRICE + (restaurantData.isSeoEnabled ? SEO_EXTRA_PRICE : 0));
}

function updateSeoCheckbox() {
    const seoCheckbox = document.getElementById('seoCheckbox');
    const seoPriceDetails = document.getElementById('seoPriceDetails');

    if (!seoCheckbox) return;

    if (restaurantData.isSeoEnabled) {
        seoCheckbox.classList.remove('border-gray-300', 'bg-white');
        seoCheckbox.classList.add('border-purple-500', 'bg-purple-500');
        seoCheckbox.querySelector('i').classList.remove('opacity-0');
        seoCheckbox.querySelector('i').classList.add('opacity-100');
        if (seoPriceDetails) seoPriceDetails.classList.remove('hidden');
    } else {
        seoCheckbox.classList.remove('border-purple-500', 'bg-purple-500');
        seoCheckbox.classList.add('border-gray-300', 'bg-white');
        seoCheckbox.querySelector('i').classList.remove('opacity-100');
        seoCheckbox.querySelector('i').classList.add('opacity-0');
        if (seoPriceDetails) seoPriceDetails.classList.add('hidden');
    }
}

function updateTotalPrice() {
    const totalPriceElement = document.getElementById('totalPrice');
    const basePriceElement = document.querySelector('#seoPriceDetails div:first-child span:last-child');
    const seoPriceElement = document.querySelector('#seoPriceDetails div:nth-child(2) span:last-child');

    if (!totalPriceElement) return;

    let total = BASE_PRICE;
    if (restaurantData.isSeoEnabled) {
        total += SEO_EXTRA_PRICE;
    }

    const formattedPrice = (total / 10).toLocaleString('fa-IR') + ' تومان';
    totalPriceElement.textContent = formattedPrice;

    if (basePriceElement) {
        basePriceElement.textContent = (BASE_PRICE / 10).toLocaleString('fa-IR') + ' تومان';
    }

    if (seoPriceElement) {
        if (restaurantData.isSeoEnabled) {
            seoPriceElement.textContent = '+' + (SEO_EXTRA_PRICE / 10).toLocaleString('fa-IR') + ' تومان';
            seoPriceElement.classList.add('text-purple-600', 'font-bold');
        } else {
            seoPriceElement.textContent = '+۰ تومان';
            seoPriceElement.classList.remove('text-purple-600', 'font-bold');
        }
    }
}

// Step 1 -> Step 2
function proceedToStep2() {
    const fullNameInput = document.getElementById('fullNameInput');
    const restaurantNameInput = document.getElementById('restaurantNameInput');

    if (!fullNameInput || !restaurantNameInput) {
        alert('خطا در بارگذاری فرم');
        return;
    }

    const fullName = fullNameInput.value.trim();
    const restaurantName = restaurantNameInput.value.trim();

    if (!fullName || !restaurantName) {
        alert('لطفاً تمام فیلدها را پر کنید');
        return;
    }

    const nameParts = fullName.split(' ');
    let name = '';
    let family = '';

    if (nameParts.length > 0) {
        name = nameParts[0];
        if (nameParts.length > 1) {
            family = nameParts.slice(1).join(' ');
        }
    }

    restaurantData.step1 = {
        name: name,
        family: family,
        restaurant_name: restaurantName
    };

    showStep(2);
}

function backToStep1() {
    showStep(1);
}

// Step 2 -> Step 3
function checkEnglishName() {
    const englishNameInput = document.getElementById('englishNameInput');
    const feedback = document.getElementById('englishNameFeedback');
    const button = document.getElementById('step2Button');
    const menuUrl = document.getElementById('menuUrlPreview');

    if (!englishNameInput || !feedback || !button || !menuUrl) {
        return;
    }

    const englishName = englishNameInput.value.trim().toLowerCase();
    menuUrl.textContent = `/menu/${englishName}`;
    clearTimeout(checkTimeout);

    if (!englishName) {
        feedback.innerHTML = '<span class="text-red-500 flex items-center"><i class="fas fa-times-circle ml-1"></i> نام انگلیسی نمی‌تواند خالی باشد</span>';
        button.disabled = true;
        return;
    }

    const englishNameRegex = /^[a-z0-9-]+$/;
    if (!englishNameRegex.test(englishName)) {
        feedback.innerHTML = '<span class="text-red-500 flex items-center"><i class="fas fa-times-circle ml-1"></i> فقط حروف انگلیسی، اعداد و خط تیره مجاز است</span>';
        button.disabled = true;
        return;
    }

    feedback.innerHTML = '<span class="text-blue-500 flex items-center"><i class="fas fa-spinner fa-spin ml-1"></i> در حال بررسی...</span>';
    button.disabled = true;

    checkTimeout = setTimeout(() => {
        fetch(`{% url 'panel:check_english_name' %}?english_name=${encodeURIComponent(englishName)}`)
            .then(response => response.json())
            .then(data => {
                if (data.available) {
                    feedback.innerHTML = '<span class="text-green-500 flex items-center"><i class="fas fa-check-circle ml-1"></i> ' + data.message + '</span>';
                    button.disabled = false;
                    restaurantData.step2 = { english_name: englishName };
                } else {
                    feedback.innerHTML = '<span class="text-red-500 flex items-center"><i class="fas fa-times-circle ml-1"></i> ' + data.message + '</span>';
                    button.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                feedback.innerHTML = '<span class="text-red-500 flex items-center"><i class="fas fa-times-circle ml-1"></i> خطا در بررسی نام انگلیسی</span>';
                button.disabled = true;
            });
    }, 500);
}

function proceedToStep3() {
    showStep(3);
}

// Step 3: انتخاب نوع ساخت منو
function selectMenuCreation(type) {
    restaurantData.menuCreationType = type;

    if (type === 'self') {
        createRestaurantFinal();
    } else {
        showStep(4);
    }
}

function backToStep3() {
    showStep(3);
}

// Step 4: آپلود عکس‌ها
function setupFileUpload() {
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('menuImagesInput');

    if (!dropZone || !fileInput) {
        console.error('Dropzone or file input not found');
        return;
    }

    const newFileInput = fileInput.cloneNode(true);
    fileInput.parentNode.replaceChild(newFileInput, fileInput);

    document.addEventListener('click', function(e) {
        if (e.target.closest('#dropZone') && restaurantData.uploadedImages.length < MAX_IMAGES) {
            document.getElementById('menuImagesInput').click();
        }
    });

    document.getElementById('menuImagesInput').addEventListener('change', handleFileSelect);

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        if (restaurantData.uploadedImages.length < MAX_IMAGES) {
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        }
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('border-blue-500', 'bg-blue-50');

        if (e.dataTransfer.files.length && restaurantData.uploadedImages.length < MAX_IMAGES) {
            const newFiles = Array.from(e.dataTransfer.files);
            handleNewFiles(newFiles);
        }
    });

    updateDropZoneState();
}

function handleFileSelect(event) {
    const files = event.target.files;
    if (files.length > 0) {
        const newFiles = Array.from(files);
        handleNewFiles(newFiles);
        event.target.value = '';
    }
}

function handleNewFiles(newFiles) {
    const remainingSlots = MAX_IMAGES - restaurantData.uploadedImages.length;

    if (newFiles.length > remainingSlots) {
        showMessage(`فقط می‌توانید ${remainingSlots} عکس دیگر آپلود کنید`, 'error');
        newFiles = newFiles.slice(0, remainingSlots);
    }

    if (newFiles.length === 0) return;

    const validFiles = newFiles.filter(file => {
        if (!file.type.startsWith('image/')) {
            return false;
        }
        return !restaurantData.uploadedImages.some(
            existingFile => existingFile.name === file.name && existingFile.size === file.size
        );
    });

    if (validFiles.length === 0) {
        showMessage('لطفاً فقط فایل‌های تصویری انتخاب کنید', 'error');
        return;
    }

    if (validFiles.length > 0) {
        showMessage(`${validFiles.length} عکس با موفقیت انتخاب شد`, 'success');
    }

    validFiles.forEach(file => {
        restaurantData.uploadedImages.push(file);
    });

    updateImagePreview();
}

function updateDropZoneState() {
    const dropZone = document.getElementById('dropZone');
    if (!dropZone) return;

    const remainingSlots = MAX_IMAGES - restaurantData.uploadedImages.length;

    if (restaurantData.uploadedImages.length === 0) {
        dropZone.classList.remove('border-green-400', 'border-red-400', 'opacity-50', 'cursor-not-allowed');
        dropZone.classList.add('border-gray-300', 'cursor-pointer');
        dropZone.innerHTML = `
            <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-3"></i>
            <p class="text-gray-600 font-medium">برای انتخاب عکس‌ها اینجا کلیک کنید</p>
            <p class="text-sm text-gray-500 mt-2">یا عکس‌ها را اینجا بکشید و رها کنید (حداکثر ۱۰ عکس)</p>
            <input type="file" id="menuImagesInput" multiple accept="image/*" class="hidden">
        `;
    } else if (restaurantData.uploadedImages.length >= MAX_IMAGES) {
        dropZone.classList.remove('border-gray-300', 'cursor-pointer');
        dropZone.classList.add('border-green-400', 'opacity-50', 'cursor-not-allowed');
        dropZone.innerHTML = `
            <i class="fas fa-check-circle text-4xl text-green-400 mb-3"></i>
            <p class="text-gray-600">حداکثر تعداد عکس آپلود شده</p>
            <p class="text-sm text-gray-500 mt-2">برای آپلود بیشتر، ابتدا برخی عکس‌ها را حذف کنید</p>
            <input type="file" id="menuImagesInput" multiple accept="image/*" class="hidden">
        `;
    } else {
        dropZone.classList.remove('border-gray-300', 'opacity-50', 'cursor-not-allowed');
        dropZone.classList.add('border-blue-400', 'cursor-pointer');
        dropZone.innerHTML = `
            <i class="fas fa-plus-circle text-4xl text-blue-400 mb-3"></i>
            <p class="text-gray-600">عکس‌های بیشتر اضافه کنید</p>
            <p class="text-sm text-gray-500 mt-2">می‌توانید ${remainingSlots} عکس دیگر آپلود کنید</p>
            <input type="file" id="menuImagesInput" multiple accept="image/*" class="hidden">
        `;
    }

    const newFileInput = document.getElementById('menuImagesInput');
    if (newFileInput) {
        newFileInput.addEventListener('change', handleFileSelect);
    }
}

function updateImagePreview() {
    const preview = document.getElementById('imagePreview');
    const uploadButton = document.getElementById('uploadButton');
    const saveButton = document.getElementById('saveImagesButton');
    const imageCounter = document.getElementById('imageCounter');
    const currentCount = document.getElementById('currentCount');
    const progressFill = document.getElementById('progressFill');

    if (!preview || !imageCounter || !currentCount || !progressFill) return;

    preview.innerHTML = '';
    currentCount.textContent = restaurantData.uploadedImages.length;

    const progressPercentage = (restaurantData.uploadedImages.length / MAX_IMAGES) * 100;
    progressFill.style.width = `${progressPercentage}%`;

    updateDropZoneState();

    if (restaurantData.uploadedImages.length === 0) {
        preview.classList.add('hidden');
        imageCounter.classList.add('hidden');
        if (uploadButton) uploadButton.disabled = true;
        if (saveButton) saveButton.disabled = true;
        restaurantData.imagesSaved = false;
        return;
    }

    preview.classList.remove('hidden');
    imageCounter.classList.remove('hidden');
    if (saveButton) saveButton.disabled = false;

    if (uploadButton) uploadButton.disabled = !restaurantData.imagesSaved;

    restaurantData.uploadedImages.forEach((file, index) => {
        const imgContainer = document.createElement('div');
        imgContainer.className = 'relative group';
        imgContainer.dataset.fileIndex = index;

        const img = document.createElement('img');
        const objectUrl = URL.createObjectURL(file);
        img.src = objectUrl;
        img.className = 'w-full h-24 object-cover rounded-xl border-2 border-gray-200 group-hover:border-blue-400 transition-all';
        img.alt = `عکس منو ${index + 1}`;

        const overlay = document.createElement('div');
        overlay.className = 'absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 rounded-xl transition-all flex items-center justify-center';

        const removeBtn = document.createElement('button');
        removeBtn.innerHTML = '<i class="fas fa-times"></i>';
        removeBtn.className = 'w-8 h-8 bg-red-500 text-white rounded-full text-sm flex items-center justify-center hover:bg-red-600 transition-all opacity-0 group-hover:opacity-100 transform scale-75 group-hover:scale-100';
        removeBtn.title = 'حذف عکس';
        removeBtn.onclick = (e) => {
            e.stopPropagation();
            removeImage(index);
        };

        const imageNumber = document.createElement('div');
        imageNumber.className = 'absolute top-2 left-2 bg-black bg-opacity-70 text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold';
        imageNumber.textContent = index + 1;

        overlay.appendChild(removeBtn);
        imgContainer.appendChild(img);
        imgContainer.appendChild(overlay);
        imgContainer.appendChild(imageNumber);
        preview.appendChild(imgContainer);
    });

    if (restaurantData.uploadedImages.length === MAX_IMAGES) {
        showMessage(`حداکثر تعداد عکس (${MAX_IMAGES}) آپلود شد`, 'info');
    }
}

function removeImage(index) {
    const removedFile = restaurantData.uploadedImages[index];
    restaurantData.uploadedImages.splice(index, 1);
    showMessage(`عکس "${removedFile.name}" حذف شد`, 'info');
    restaurantData.imagesSaved = false;
    updateImagePreview();
}

function showMessage(message, type = 'info') {
    const existingMessages = document.querySelectorAll('.upload-message');
    existingMessages.forEach(msg => msg.remove());

    const dropZone = document.getElementById('dropZone');
    if (!dropZone) return;

    const messageDiv = document.createElement('div');
    messageDiv.className = `upload-message p-3 rounded-xl mb-4 text-sm ${
        type === 'error' ? 'bg-red-100 text-red-700 border border-red-200' :
        type === 'success' ? 'bg-green-100 text-green-700 border border-green-200' :
        'bg-blue-100 text-blue-700 border border-blue-200'
    }`;

    messageDiv.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'error' ? 'fa-exclamation-circle' :
                type === 'success' ? 'fa-check-circle' :
                'fa-info-circle'
            } ml-2"></i>
            <span>${message}</span>
        </div>
    `;

    dropZone.parentNode.insertBefore(messageDiv, dropZone);

    setTimeout(() => {
        if (messageDiv.parentNode) {
            messageDiv.remove();
        }
    }, 4000);
}

// تابع برای ذخیره عکس‌ها
function saveImages() {
    if (restaurantData.uploadedImages.length === 0) {
        showMessage('لطفاً حداقل یک عکس آپلود کنید', 'error');
        return;
    }

    const saveButton = document.getElementById('saveImagesButton');
    const uploadButton = document.getElementById('uploadButton');
    if (!saveButton || !uploadButton) return;

    saveButton.disabled = true;
    saveButton.innerHTML = '<i class="fas fa-spinner fa-spin ml-2"></i> در حال ذخیره...';

    const formData = new FormData();
    formData.append('step', 'create_with_company');
    formData.append('name', restaurantData.step1.name);
    formData.append('family', restaurantData.step1.family);
    formData.append('restaurant_name', restaurantData.step1.restaurant_name);
    formData.append('english_name', restaurantData.step2.english_name);
    formData.append('menu_creation_type', 'company_save_only');
    formData.append('is_seo_enabled', restaurantData.isSeoEnabled ? '1' : '0');

    restaurantData.uploadedImages.forEach((file, index) => {
        formData.append(`menu_images`, file);
    });

    console.log('ارسال داده‌ها برای ذخیره عکس - سئو فعال:', restaurantData.isSeoEnabled);

    fetch("{% url 'panel:create_restaurant_modal' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('خطا در پاسخ سرور: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('پاسخ سرور:', data);

        if (data.success) {
            showMessage(data.message, 'success');
            restaurantData.imagesSaved = true;
            uploadButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-check ml-2"></i> عکس‌ها ذخیره شد';
            saveButton.classList.remove('from-green-500', 'to-emerald-500', 'hover:from-green-600', 'hover:to-emerald-600');
            saveButton.classList.add('from-green-600', 'to-emerald-600', 'cursor-default');
        } else {
            showMessage(data.message || 'خطا در ذخیره عکس‌ها', 'error');
            restaurantData.imagesSaved = false;
            uploadButton.disabled = true;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showMessage('خطا در ارتباط با سرور: ' + error.message, 'error');
        restaurantData.imagesSaved = false;
        uploadButton.disabled = true;
    })
    .finally(() => {
        if (!restaurantData.imagesSaved) {
            saveButton.disabled = false;
            saveButton.innerHTML = '<i class="fas fa-save ml-2"></i> ذخیره عکس‌ها';
        }
    });
}

// Step 4 -> Step 5 (پرداخت)
function proceedToPayment() {
    if (restaurantData.uploadedImages.length === 0) {
        showMessage('لطفاً حداقل یک عکس آپلود کنید', 'error');
        return;
    }

    if (!restaurantData.imagesSaved) {
        showMessage('لطفاً ابتدا عکس‌ها را ذخیره کنید', 'error');
        return;
    }

    showStep(5);
    const processingTitle = document.getElementById('processingTitle');
    const processingMessage = document.getElementById('processingMessage');
    const progressBar = document.getElementById('progressBarAnimated');

    if (processingTitle) processingTitle.textContent = 'در حال ارسال اطلاعات...';
    if (processingMessage) processingMessage.textContent = 'لطفاً چند لحظه صبر کنید';
    if (progressBar) progressBar.style.width = '30%';

    setTimeout(() => {
        if (progressBar) progressBar.style.width = '70%';
        processCompanyMenuCreation();
    }, 1000);
}

// ایجاد رستوران نهایی (ساخت توسط خود کاربر)
function createRestaurantFinal() {
    showStep(5);
    const processingTitle = document.getElementById('processingTitle');
    const processingMessage = document.getElementById('processingMessage');
    const progressBar = document.getElementById('progressBarAnimated');

    if (processingTitle) processingTitle.textContent = 'در حال ایجاد رستوران...';
    if (processingMessage) processingMessage.textContent = 'لطفاً چند لحظه صبر کنید';
    if (progressBar) progressBar.style.width = '30%';

    console.log('ایجاد رستوران نهایی - سئو فعال:', restaurantData.isSeoEnabled);

    fetch("{% url 'panel:create_restaurant_modal' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            step: 3,
            name: restaurantData.step1.name,
            family: restaurantData.step1.family,
            restaurant_name: restaurantData.step1.restaurant_name,
            english_name: restaurantData.step2.english_name,
            is_seo_enabled: restaurantData.isSeoEnabled
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('خطا در پاسخ سرور: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('پاسخ ایجاد رستوران:', data);
        if (progressBar) progressBar.style.width = '100%';

        if (data.success) {
            if (processingTitle) processingTitle.textContent = 'رستوران با موفقیت ایجاد شد!';
            if (processingMessage) processingMessage.textContent = 'در حال انتقال به پنل مدیریت...';

            clearPendingRestaurant();

            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1500);
        } else {
            alert('خطا: ' + data.message);
            showStep(2);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در ایجاد رستوران: ' + error.message);
        showStep(2);
    });
}

// پردازش ساخت منو توسط شرکت
function processCompanyMenuCreation() {
    const formData = new FormData();
    formData.append('step', 'create_with_company');
    formData.append('name', restaurantData.step1.name);
    formData.append('family', restaurantData.step1.family);
    formData.append('restaurant_name', restaurantData.step1.restaurant_name);
    formData.append('english_name', restaurantData.step2.english_name);
    formData.append('menu_creation_type', 'company');
    formData.append('is_seo_enabled', restaurantData.isSeoEnabled ? '1' : '0');

    restaurantData.uploadedImages.forEach((file, index) => {
        formData.append(`menu_images`, file);
    });

    console.log('ارسال داده‌ها برای پرداخت - سئو فعال:', restaurantData.isSeoEnabled);
    console.log('قیمت نهایی:', BASE_PRICE + (restaurantData.isSeoEnabled ? SEO_EXTRA_PRICE : 0));

    fetch("{% url 'panel:create_restaurant_modal' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('خطا در پاسخ سرور: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('پاسخ پرداخت:', data);
        const progressBar = document.getElementById('progressBarAnimated');
        if (progressBar) progressBar.style.width = '100%';

        if (data.success) {
            const processingTitle = document.getElementById('processingTitle');
            const processingMessage = document.getElementById('processingMessage');

            if (processingTitle) processingTitle.textContent = 'در حال انتقال به درگاه پرداخت...';
            if (processingMessage) processingMessage.textContent = 'لطفاً چند لحظه صبر کنید';

            clearPendingRestaurant();

            setTimeout(() => {
                window.location.href = data.redirect_url;
            }, 1500);
        } else {
            if (data.message.includes('نام انگلیسی قبلاً انتخاب شده')) {
                clearPendingRestaurant();
                showStep(2);
                alert('خطا: ' + data.message + '\nلطفاً نام انگلیسی دیگری انتخاب کنید.');
            } else {
                alert('خطا: ' + data.message);
                showStep(4);
            }
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('خطا در پردازش درخواست: ' + error.message);
        showStep(4);
    });
}

// بررسی وضعیت رستوران در حال انتظار
function checkPendingRestaurant() {
    fetch("{% url 'panel:check_pending_restaurant' %}")
        .then(response => response.json())
        .then(data => {
            if (data.has_pending) {
                console.log('رستوران در حال انتظار وجود دارد:', data.data);
            }
        })
        .catch(error => {
            console.error('Error checking pending restaurant:', error);
        });
}

// پاک کردن رستوران در حال انتظار
function clearPendingRestaurant() {
    fetch("{% url 'panel:clear_pending_restaurant' %}", {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('رستوران در حال انتظار پاک شد');
        }
    })
    .catch(error => {
        console.error('Error clearing pending restaurant:', error);
    });
}

// مدیریت فوکوس اتوماتیک بین فیلدها
function setupAutoFocus() {
    const fullNameInput = document.getElementById('fullNameInput');
    const restaurantNameInput = document.getElementById('restaurantNameInput');

    if (fullNameInput && restaurantNameInput) {
        fullNameInput.addEventListener('input', function() {
            clearTimeout(fullNameTimeout);

            if (this.value.includes(' ') && this.value.trim() !== '') {
                fullNameTimeout = setTimeout(() => {
                    restaurantNameInput.focus();
                }, 1000);
            }
        });

        fullNameInput.addEventListener('keydown', function(e) {
            if (e.key === ' ') {
                clearTimeout(fullNameTimeout);
            }
        });
    }
}

// مدیریت رویدادهای مودال
const modal = document.getElementById('createRestaurantModal');
if (modal) {
    modal.addEventListener('click', function(e) {
        if (e.target.id === 'createRestaurantModal') {
            closeCreateRestaurantModal();
        }
    });
}

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCreateRestaurantModal();
    }
});

// بررسی وضعیت رستوران در حال انتظار هنگام بارگذاری صفحه
document.addEventListener('DOMContentLoaded', function() {
    checkPendingRestaurant();
    setupAutoFocus();
});
</script>