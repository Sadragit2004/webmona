<!-- فایل: panel_dashboard.html -->
<div class="w-full max-w-7xl mx-auto">

    <!-- آمار کلی - طراحی ریسپانسیو -->
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
        <!-- کارت منوهای ساخته شده -->
        <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl p-6 shadow-lg hover-lift transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-blue-100 text-sm mb-2">منوهای ساخته شده</p>
                    <h3 class="text-2xl font-bold">{{ user_restaurants.count|default:0 }}</h3>
                    <p class="text-blue-100 text-xs mt-2">همه منوهای فعال</p>
                </div>
                <div class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-utensils text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- کارت منوهای خریداری شده -->
        <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl p-6 shadow-lg hover-lift transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-green-100 text-sm mb-2">منوهای خریداری شده</p>
                    <h3 class="text-2xl font-bold">{{ purchased_menus|default:0 }}</h3>
                    <p class="text-green-100 text-xs mt-2">پکیج‌های فعال</p>
                </div>
                <div class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-shopping-cart text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- کارت سفارشات امروز -->
        <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl p-6 shadow-lg hover-lift transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-purple-100 text-sm mb-2">سفارشات امروز</p>
                    <h3 class="text-2xl font-bold">{{ today_orders|default:0 }}</h3>
                    <p class="text-purple-100 text-xs mt-2">24 ساعت گذشته</p>
                </div>
                <div class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-receipt text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- کارت درآمد امروز -->
        <div class="bg-gradient-to-br from-orange-500 to-orange-600 text-white rounded-xl p-6 shadow-lg hover-lift transition-all duration-300">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-orange-100 text-sm mb-2">درآمد امروز</p>
                    <h3 class="text-2xl font-bold">{{ today_revenue|default:0 }}</h3>
                    <p class="text-orange-100 text-xs mt-2">تومان</p>
                </div>
                <div class="w-14 h-14 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                    <i class="fas fa-wallet text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- محتوای اصلی - طرح دو ستونی برای دسکتاپ -->
    <div class="flex flex-col xl:flex-row gap-6">

        <!-- ستون سمت چپ - سفارشات زنده و آمار -->
        <div class="xl:w-2/3 space-y-6">

            <!-- سفارشات زنده -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-xl font-bold text-gray-800 flex items-center">
                            <i class="fas fa-bell text-yellow-500 ml-3 text-lg"></i>
                            سفارشات زنده
                        </h2>
                        <div class="flex items-center space-x-3 space-x-reverse">
                            <span class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm font-medium animate-pulse">
                                <i class="fas fa-circle ml-1 text-xs"></i>
                                زنده
                            </span>
                            <span class="text-gray-500 text-sm">
                                آخرین بروزرسانی: <span id="lastUpdateTime">هم اکنون</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="p-6">
                    {% if live_orders %}
                    <div class="space-y-4" id="liveOrdersContainer">
                        {% for order in live_orders %}
                        <div class="border border-gray-200 rounded-xl p-5 hover:shadow-lg transition-all duration-300 gradient-border">
                            <div class="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4">
                                <!-- اطلاعات سفارش -->
                                <div class="flex-1">
                                    <div class="flex items-center flex-wrap gap-2 mb-4">
                                        <span class="bg-blue-100 text-blue-600 px-3 py-1 rounded-lg text-sm font-medium">
                                            <i class="fas fa-table ml-1"></i>
                                            میز {{ order.table_number|default:"-" }}
                                        </span>
                                        <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-lg text-sm font-medium">
                                            {{ order.get_status_display }}
                                        </span>
                                        <span class="text-gray-500 text-sm">
                                            <i class="fas fa-clock ml-1"></i>
                                            {{ order.created_at|timesince }} قبل
                                        </span>
                                    </div>

                                    <!-- لیست غذاها -->
                                    <div class="mb-4">
                                        <h4 class="font-semibold text-gray-800 mb-3 flex items-center">
                                            <i class="fas fa-list ml-2 text-gray-400"></i>
                                            موارد سفارش
                                        </h4>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                                            {% for item in order.items.all %}
                                            <div class="flex items-center justify-between bg-gray-50 rounded-lg p-3">
                                                <div class="flex items-center">
                                                    <span class="text-gray-700 font-medium">{{ item.food.title }}</span>
                                                </div>
                                                <div class="flex items-center space-x-2 space-x-reverse">
                                                    <span class="bg-white px-2 py-1 rounded text-sm font-medium border">
                                                        ×{{ item.quantity }}
                                                    </span>
                                                    <span class="text-green-600 text-sm font-medium">
                                                        {{ item.total_price|floatformat:0 }} تومان
                                                    </span>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>

                                    <!-- اطلاعات پایین -->
                                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between pt-4 border-t border-gray-100 space-y-2 sm:space-y-0">
                                        <div class="flex items-center text-sm text-gray-600">
                                            <i class="fas fa-clock ml-1"></i>
                                            زمان تقریبی:
                                            <span class="font-medium mr-1">{{ order.estimated_time }}</span>
                                            دقیقه
                                        </div>
                                        <div class="text-lg font-bold text-gray-800">
                                            جمع کل: {{ order.total_price|floatformat:0 }} تومان
                                        </div>
                                    </div>
                                </div>

                                <!-- دکمه‌های اقدام -->
                                <div class="flex flex-col space-y-3 min-w-[200px]">
                                    {% if order.status == 'pending' %}
                                    <button onclick="updateOrderStatus({{ order.id }}, 'preparing')"
                                            class="w-full bg-blue-500 hover:bg-blue-600 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 flex items-center justify-center">
                                        <i class="fas fa-play ml-2"></i>
                                        شروع آماده‌سازی
                                    </button>
                                    {% elif order.status == 'preparing' %}
                                    <button onclick="updateOrderStatus({{ order.id }}, 'ready')"
                                            class="w-full bg-green-500 hover:bg-green-600 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 flex items-center justify-center">
                                        <i class="fas fa-check ml-2"></i>
                                        آماده شد
                                    </button>
                                    {% elif order.status == 'ready' %}
                                    <button onclick="updateOrderStatus({{ order.id }}, 'completed')"
                                            class="w-full bg-purple-500 hover:bg-purple-600 text-white px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 flex items-center justify-center">
                                        <i class="fas fa-check-double ml-2"></i>
                                        تحویل داده شد
                                    </button>
                                    {% endif %}

                                    <button onclick="viewOrderDetails({{ order.id }})"
                                            class="w-full bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 flex items-center justify-center">
                                        <i class="fas fa-eye ml-2"></i>
                                        مشاهده جزئیات
                                    </button>

                                    <button onclick="printOrder({{ order.id }})"
                                            class="w-full border border-gray-300 hover:border-gray-400 text-gray-600 px-4 py-3 rounded-xl text-sm font-medium transition-all duration-300 flex items-center justify-center">
                                        <i class="fas fa-print ml-2"></i>
                                        چاپ سفارش
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <!-- حالت خالی -->
                    <div class="text-center py-12">
                        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 mx-auto mb-4">
                            <i class="fas fa-receipt text-3xl"></i>
                        </div>
                        <h3 class="text-gray-500 text-lg font-medium mb-2">هیچ سفارش فعالی وجود ندارد</h3>
                        <p class="text-gray-400 max-w-md mx-auto">
                            سفارشات جدید مشتریان به صورت زنده در این بخش نمایش داده می‌شوند
                        </p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- آمار سریع -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-6 flex items-center">
                    <i class="fas fa-chart-line text-green-500 ml-3 text-lg"></i>
                    آمار و عملکرد
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 border border-blue-200 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-600 text-sm font-medium">بازدید امروز</p>
                                <h3 class="text-2xl font-bold text-blue-700 mt-1">{{ today_views|default:0 }}</h3>
                            </div>
                            <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-eye text-white text-sm"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-50 to-green-100 border border-green-200 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-600 text-sm font-medium">سفارش این ماه</p>
                                <h3 class="text-2xl font-bold text-green-700 mt-1">{{ monthly_orders|default:0 }}</h3>
                            </div>
                            <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-shopping-cart text-white text-sm"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 border border-purple-200 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-600 text-sm font-medium">درآمد ماه</p>
                                <h3 class="text-2xl font-bold text-purple-700 mt-1">{{ monthly_revenue|default:0 }}</h3>
                            </div>
                            <div class="w-10 h-10 bg-purple-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-wallet text-white text-sm"></i>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-orange-50 to-orange-100 border border-orange-200 rounded-xl p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-orange-600 text-sm font-medium">میانگین امتیاز</p>
                                <h3 class="text-2xl font-bold text-orange-700 mt-1">{{ average_rating|default:"-" }}/5</h3>
                            </div>
                            <div class="w-10 h-10 bg-orange-500 rounded-full flex items-center justify-center">
                                <i class="fas fa-star text-white text-sm"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ستون سمت راست - منوها و نکات -->
        <div class="xl:w-1/3 space-y-6">

            <!-- منوهای شما -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100">
                <div class="p-6 border-b border-gray-100">
                    <h2 class="text-xl font-bold text-gray-800 flex items-center">
                        <i class="fas fa-utensils text-blue-500 ml-3 text-lg"></i>
                        منوهای شما
                    </h2>
                </div>

                <div class="p-6">
                    {% if user_restaurants %}
                    <div class="space-y-4">
                        {% for restaurant in user_restaurants %}
                        <div class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-all duration-300">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <h3 class="font-semibold text-gray-800 mb-2">{{ restaurant.title }}</h3>
                                    <p class="text-gray-500 text-sm mb-3 flex items-center">
                                        <i class="fas fa-link ml-1 text-gray-400"></i>
                                        /menu/{{ restaurant.slug }}
                                    </p>
                                    <div class="flex items-center space-x-2 space-x-reverse flex-wrap gap-2">
                                        <span class="bg-green-100 text-green-600 px-2 py-1 rounded text-xs font-medium">
                                            {{ restaurant.foods.count }} غذا
                                        </span>
                                        <span class="bg-blue-100 text-blue-600 px-2 py-1 rounded text-xs font-medium">
                                            {{ restaurant.categories.count }} دسته‌بندی
                                        </span>
                                        <span class="bg-purple-100 text-purple-600 px-2 py-1 rounded text-xs font-medium">
                                            {{ restaurant.orders.count }} سفارش
                                        </span>
                                    </div>
                                </div>
                                <div class="flex flex-col space-y-2 mr-4">
                                    <a href="{% url 'panel:restaurant_admin' slug=restaurant.slug %}"
                                       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg text-xs text-center transition-colors whitespace-nowrap">
                                        مدیریت منو
                                    </a>
                                    <button onclick="copyMenuLink('{{ restaurant.slug }}')"
                                            class="bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg text-xs transition-colors whitespace-nowrap">
                                        کپی لینک
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-8">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center text-gray-400 mx-auto mb-4">
                            <i class="fas fa-utensils text-2xl"></i>
                        </div>
                        <p class="text-gray-500 mb-4">هنوز منویی نساخته‌اید</p>
                        <button onclick="openCreateRestaurantModal()"
                                class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-medium transition-colors">
                            ساخت اولین منو
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- نکات و پیشنهادات -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-100 border border-blue-200 rounded-2xl p-6">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
                    <i class="fas fa-lightbulb text-yellow-500 ml-2"></i>
                    راهنمای افزایش فروش
                </h3>

                <div class="space-y-3">
                    <div class="flex items-start space-x-3 space-x-reverse">
                        <div class="w-6 h-6 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <i class="fas fa-qrcode text-white text-xs"></i>
                        </div>
                        <p class="text-sm text-gray-700">
                            <strong>QR Code روی میزها:</strong> برای افزایش ۳ برابری سفارشات
                        </p>
                    </div>

                    <div class="flex items-start space-x-3 space-x-reverse">
                        <div class="w-6 h-6 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <i class="fas fa-image text-white text-xs"></i>
                        </div>
                        <p class="text-sm text-gray-700">
                            <strong>عکس‌های باکیفیت:</strong> ۶۰٪ افزایش جذابیت منو
                        </p>
                    </div>

                    <div class="flex items-start space-x-3 space-x-reverse">
                        <div class="w-6 h-6 bg-purple-500 rounded-full flex items-center justify-center flex-shrink-0 mt-1">
                            <i class="fas fa-bolt text-white text-xs"></i>
                        </div>
                        <p class="text-sm text-gray-700">
                            <strong>توضیحات صوتی:</strong> تجربه متفاوت برای مشتریان
                        </p>
                    </div>
                </div>

                <div class="mt-6 pt-4 border-t border-blue-200">
                    <a href="#" class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                        راهنمای کامل استفاده
                        <i class="fas fa-arrow-left mr-2"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// تابع کپی لینک منو
function copyMenuLink(slug) {
    const link = `${window.location.origin}/menu/${slug}`;
    navigator.clipboard.writeText(link).then(() => {
        showNotification('لینک منو در کلیپ‌بورد کپی شد ✅');
    });
}

// تابع به‌روزرسانی وضعیت سفارش
function updateOrderStatus(orderId, newStatus) {
    fetch(`/panel/orders/${orderId}/update-status/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            status: newStatus
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('وضعیت سفارش به‌روزرسانی شد ✅');
            location.reload();
        } else {
            showNotification('خطا در به‌روزرسانی وضعیت ❌', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('خطا در ارتباط با سرور ❌', 'error');
    });
}

// تابع چاپ سفارش
function printOrder(orderId) {
    window.open(`/panel/orders/${orderId}/print/`, '_blank');
}

// تابع نمایش نوتیفیکیشن
function showNotification(message, type = 'success') {
    // ایجاد نوتیفیکیشن
    const notification = document.createElement('div');
    notification.className = `fixed top-6 left-1/2 transform -translate-x-1/2 z-50 px-6 py-3 rounded-xl shadow-lg text-white font-medium ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } animate-bounce`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// به‌روزرسانی زمان آخرین بروزرسانی
function updateLastUpdateTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString('fa-IR');
    document.getElementById('lastUpdateTime').textContent = timeString;
}

// شروع به‌روزرسانی‌های زنده
document.addEventListener('DOMContentLoaded', function() {
    updateLastUpdateTime();
    setInterval(updateLastUpdateTime, 60000); // بروزرسانی زمان هر 1 دقیقه
});
</script>

<style>
.hover-lift:hover {
    transform: translateY(-4px);
    transition: transform 0.3s ease;
}

.animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
    0%, 100% {
        opacity: 1;
    }
    50% {
        opacity: 0.7;
    }
}

.gradient-border {
    background: linear-gradient(white, white) padding-box,
                linear-gradient(45deg, #3B82F6, #10B981) border-box;
    border: 2px solid transparent;
    border-radius: 12px;
}

.animate-bounce {
    animation: bounce 0.5s;
}

@keyframes bounce {
    0%, 20%, 53%, 80%, 100% {
        transform: translate3d(-50%, 0, 0);
    }
    40%, 43% {
        transform: translate3d(-50%, -15px, 0);
    }
    70% {
        transform: translate3d(-50%, -10px, 0);
    }
    90% {
        transform: translate3d(-50%, -5px, 0);
    }
}

/* responsive improvements */
@media (max-width: 768px) {
    .container {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

@media (min-width: 1536px) {
    .container {
        max-width: 1280px;
    }
}
</style>